{% extends "base.html" %}
{% block title %} Добавить новое соединение {% endblock %}
{% load static %}
{% block content %}
{% if user.is_authenticated %}

<div class="box onl-text-pg container">

    <link rel="stylesheet" href="{% static 'append.css' %}">
    <script src="{% static 'append.js' %}"  ></script>
    <div class="row">
        <div class="col-md-6">

            <div class="form-group form-outline" data-mdb-input-init>

                <input  class="form-control" list="substance_class" placeholder="Введите класс соединения...">
                <label class="form-label" for="substance_class">Класс соединения:</label>
                <datalist id="substance_class">
                    {% for class in classes %}
                    <option value="{{ class.name }}">{{ class.name }}</option>
                    {% endfor %}
                </datalist>
            </div>

            <div class="form-group" >

                <select id="substance_type" name="substance_type">
                    {% for type in types %}
                    <option value="{{ type }}">{{ type }}</option>
                    {% endfor %}
                </select>

            </div>

            <div class="form-group form-outline" data-mdb-input-init>

                <input type="text" id="name" name="name" class="form-control">
                <label class="form-label" for="name">Название:</label>
            </div>


            <div class="form-group form-outline" data-mdb-input-init>

                <input type="text" id="formula" name="formula" class="form-control">
                <label class="form-label" for="formula">Формула:</label>
            </div>

            <div class="form-group form-outline" data-mdb-input-init>

                <input type="text" id="source" name="source" class="form-control">
                <label class="form-label" for="source">От кого полученно соединение:</label>
            </div>

            <div class="form-group form-outline" data-mdb-input-init>

                <input type="text" id="cas" name="cas" class="form-control">
                <label class="form-label" for="cas">CAS:</label>
            </div>

            <div class="form-group">
                <div class="row">
                    <label for="literatura">Литература:</label>
                </div>
                <div class="row">
                    <div class="col">

                        <select id="literatura" name="literatura" multiple class="form-select">

                        </select>




                    </div>

                    <div class="col">
                        <div class="source-fields" data-mdb-input-init>
                            <input type="text" id="description" placeholder="Описание" class="form-control">
                            <input type="text" id="url" placeholder="URL" class="form-control">
                            <input type="text" id="doi" placeholder="DOI" class="form-control">

                        </div>

                    </div>
                </div>
                <div class="row">
                    <button id="add_source_btn" class="add-button btn btn-primary" >Добавить источник</button>

                </div>

                <div class="form-group">
                    <label for="phase-transitions">Фазовые переходы:</label>
                    <select id="phase-transitions" name="phase-transitions" multiple>

                    </select>

                    <button class="add-button btn btn-primary" onclick="addPhaseTransition()">Добавить фазовый переход
                    </button>

                    <div class="phase-transition-fields">
                        <select id="source_phase" >
                        {% for phase in phases %}
                    <option value="{{ phase }}">{{ phase }}</option>
                            {% endfor %}</select>
                        <select id="target_phase" >
                            {% for phase in phases %}
                    <option value="{{ phase }}">{{ phase }}</option>
                            {% endfor %}</select>
                        <select id="source_phase_number">
                        {% for number in phase_numbers %}
                    <option value="{{ number }}">{{ number }}</option>
                            {% endfor %}</select>
                        <select id="target_phase_number" >
                            {% for number in phase_numbers %}
                    <option value="{{ number }}">{{ number }}</option>
                            {% endfor %}</select>
                        <input type="number" id="temperature" placeholder="Температура" class="form-control">
                        <input type="number" id="temperature_err" placeholder="Ошибка температуры" class="form-control">
                        <input type="number" id="enthalpy_transition" placeholder="Энтальпия перехода"
                               class="form-control">
                        <input type="number" id="enthalpy_transition_err" placeholder="Ошибка энтальпии перехода"
                               class="form-control">
                        <input type="number" id="entropy_transition" placeholder="Энтропия перехода"
                               class="form-control">
                        <input type="number" id="entropy_transition_err" placeholder="Ошибка энтропии перехода"
                               class="form-control">
                        <input type="number" id="jump_heat_capacity" placeholder="Скачок теплоёмкости"
                               class="form-control">
                        <input type="number" id="start_temperature" placeholder="Начальная температура"
                               class="form-control">
                        <input type="number" id="end_temperature" placeholder="Конечная температура"
                               class="form-control">
                    </div>
                </div>
            </div>



            <script>

            </script>


        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="properties">Состояния:</label>
                <select id="properties" name="properties" multiple>

                </select>
                <script>
                </script>



                <div class="property-fields">

                    <select id="agregate_state" >
                    {% for phase in phases %}
                    <option value="{{ phase }}">{{ phase }}</option>
                    {% endfor %}
                    </select>
                    <select id="number_phase" >
                    {% for number in phase_numbers %}
                    <option value="{{ number }}">{{ number }}</option>
                            {% endfor %}</select>
                    <input type="number" id="degree_of_crystallinity" placeholder="Degree of Crystallinity"
                           class="form-control">
                    <input type="number" id="enthalpy_of_combustion" placeholder="Enthalpy of Combustion"
                           class="form-control">
                    <input type="number" id="enthalpy_of_combustion_err" placeholder="Enthalpy of Combustion Error"
                           class="form-control">
                    <input type="number" id="enthalpy_of_formation" placeholder="Enthalpy of Formation"
                           class="form-control">
                    <input type="number" id="enthalpy_of_formation_err" placeholder="Enthalpy of Formation Error"
                           class="form-control">
                    <input type="number" id="entropy_of_formation" placeholder="Entropy of Formation"
                           class="form-control">
                    <input type="number" id="entropy_of_formation_err" placeholder="Entropy of Formation Error"
                           class="form-control">
                    <input type="number" id="gibbs_energy_of_formation" placeholder="Gibbs Energy of Formation"
                           class="form-control">
                    <input type="number" id="gibbs_energy_of_formation_err"
                           placeholder="Gibbs Energy of Formation Error" class="form-control">
                    <input type="number" id="lnK" placeholder="lnK" class="form-control">
                    <input type="number" id="residual_entropy_at_0_k" placeholder="Residual Entropy at 0 K"
                           class="form-control">
                    <input type="number" id="residual_entropy_at_0_k_err" placeholder="Residual Entropy at 0 K Error"
                           class="form-control">
                    <input type="number" id="configurational_entropy" placeholder="Configurational Entropy"
                           class="form-control">
                    <input type="number" id="configurational_entropy_err" placeholder="Configurational Entropy Error"
                           class="form-control">
                    <input type="number" id="difference_of_zero" placeholder="Difference of Zero" class="form-control">
                    <input type="number" id="difference_of_zero_err" placeholder="Difference of Zero Error"
                           class="form-control">
                    <input type="text" id="T" placeholder="T (ArrayField)" class="form-control">
                    <input type="text" id="Cp" placeholder="Cp (ArrayField)" class="form-control">
                    <input type="text" id="HT_H0" placeholder="HT_H0 (ArrayField)" class="form-control">
                    <input type="text" id="ST" placeholder="ST (ArrayField)" class="form-control">
                    <input type="text" id="GT" placeholder="GT (ArrayField)" class="form-control">
                </div>
                <button class="add-button btn btn-primary" id="add_phase_btn">Добавить свойство</button>
            </div>
        </div>


    </div>

    <div class="row">
        <div class="form-group">
            <label for="phase-transition-table">Таблица фазового перехода:</label>
            <table id="phase-transition-table" class="table">
                <thead>
                <tr>
                    <th>T</th>
                    <th>Cp</th>
                    <th>H</th>
                    <th>S</th>
                    <th>G</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <button class="add-button btn btn-primary" id="add-row">Добавить строку</button>
        </div>

        <script>
    const table = document.getElementById('phase-transition-table');
    const tbody = table.getElementsByTagName('tbody')[0];
    const addRowButton = document.getElementById('add-row');

    function addRow() {
      const row = document.createElement('tr');

      for (let i = 0; i < 5; i++) {
        const cell = document.createElement('td');
        const input = document.createElement('input');
        input.type = 'text';
        input.value = '';
        cell.appendChild(input);
        row.appendChild(cell);
      }

      tbody.appendChild(row);
    }

    addRowButton.addEventListener('click', addRow);

    tbody.addEventListener('click', (event) => {
      if (event.target.tagName === 'INPUT') {
        event.target.readOnly = false;
        event.target.focus();
      }
    });

    tbody.addEventListener('input', (event) => {
      if (event.target.tagName === 'INPUT') {
        event.target.readOnly = false;
        event.target.focus();
      }
    });

    document.addEventListener('paste', function(event) {
      if (event.target.tagName === 'INPUT' && event.target.closest('table') === table) {
        event.preventDefault();

        const clipboardData = event.clipboardData || window.clipboardData;
        const pastedData = clipboardData.getData('Text');

        const rows = pastedData.trim().split('\n');
        const startRow = 0;
        const startCol = 0;

        for (let i = 0; i < rows.length; i++) {
          const cells = rows[i].split('\t');

          // Добавляем новые строки, если необходимо
          while (tbody.rows.length <= startRow + i) {
            addRow();
          }

          for (let j = 0; j < cells.length; j++) {
            const cell = tbody.rows[startRow + i].cells[startCol + j].firstChild;
            cell.value = cells[j];
          }
        }
      }
    });
    addRow();

        </script>


        <script>
    // Глобальные переменные для хранения данных
let phaseTransitionsList = [];
let selectedTransitionIndex = -1;

// Функция для добавления нового фазового перехода
function addPhaseTransition() {
  const sourcePhaseInput = document.getElementById('source_phase');
  const targetPhaseInput = document.getElementById('target_phase');
  const sourcePhaseNumberInput = document.getElementById('source_phase_number');
  const targetPhaseNumberInput = document.getElementById('target_phase_number');
  const temperatureInput = document.getElementById('temperature');
  const temperatureErrInput = document.getElementById('temperature_err');
  const enthalpyTransitionInput = document.getElementById('enthalpy_transition');
  const enthalpyTransitionErrInput = document.getElementById('enthalpy_transition_err');
  const entropyTransitionInput = document.getElementById('entropy_transition');
  const entropyTransitionErrInput = document.getElementById('entropy_transition_err');
  const jumpHeatCapacityInput = document.getElementById('jump_heat_capacity');
  const startTemperatureInput = document.getElementById('start_temperature');
  const endTemperatureInput = document.getElementById('end_temperature');

  const phaseTransition = {
    sourcePhase: sourcePhaseInput.value,
    targetPhase: targetPhaseInput.value,
    sourcePhaseNumber: parseInt(sourcePhaseNumberInput.value),
    targetPhaseNumber: parseInt(targetPhaseNumberInput.value),
    temperature: parseFloat(temperatureInput.value),
    temperatureErr: parseFloat(temperatureErrInput.value),
    enthalpyTransition: parseFloat(enthalpyTransitionInput.value),
    enthalpyTransitionErr: parseFloat(enthalpyTransitionErrInput.value),
    entropyTransition: parseFloat(entropyTransitionInput.value),
    entropyTransitionErr: parseFloat(entropyTransitionErrInput.value),
    jumpHeatCapacity: parseFloat(jumpHeatCapacityInput.value),
    startTemperature: parseFloat(startTemperatureInput.value),
    endTemperature: parseFloat(endTemperatureInput.value),
    phaseTransitionTable: [] // Добавляем новое поле для таблицы фазовых переходов
  };

const table = document.getElementById('phase-transition-table');
  const rows = table.getElementsByTagName('tr');
  for (let i = 1; i < rows.length; i++) { // Начинаем с 1, пропуская заголовок
    const cells = rows[i].getElementsByTagName('td');
    const rowData = [];
    for (let j = 0; j < cells.length; j++) {
      rowData.push(cells[j].firstChild.value);
    }
    phaseTransition.phaseTransitionTable.push(rowData);
  }

  phaseTransitionsList.push(phaseTransition);

  // Добавление нового элемента в listbox
  const option = document.createElement('option');
  option.value = phaseTransitionsList.length - 1;
  option.textContent = `${phaseTransition.sourcePhase} -> ${phaseTransition.targetPhase}`;
  document.getElementById('phase-transitions').add(option);

  // Очистка полей ввода
  sourcePhaseInput.value = '';
  targetPhaseInput.value = '';
  sourcePhaseNumberInput.value = '';
  targetPhaseNumberInput.value = '';
  temperatureInput.value = '';
  temperatureErrInput.value = '';
  enthalpyTransitionInput.value = '';
  enthalpyTransitionErrInput.value = '';
  entropyTransitionInput.value = '';
  entropyTransitionErrInput.value = '';
  jumpHeatCapacityInput.value = '';
  startTemperatureInput.value = '';
  endTemperatureInput.value = '';

    const tbody = table.getElementsByTagName('tbody')[0];

    // Очистка существующих строк таблицы
  while (tbody.firstChild) {
    tbody.removeChild(tbody.firstChild);
  }
}
function fillPhaseTransitionTable(index) {
  const selectedPhaseTransition = phaseTransitionsList[index];
  const table = document.getElementById('phase-transition-table');
  const tbody = table.getElementsByTagName('tbody')[0];

  // Очистка существующих строк таблицы
  while (tbody.firstChild) {
    tbody.removeChild(tbody.firstChild);
  }

  // Заполнение таблицы данными выбранного фазового перехода
  for (let i = 0; i < selectedPhaseTransition.phaseTransitionTable.length; i++) {
    const row = document.createElement('tr');
    for (let j = 0; j < selectedPhaseTransition.phaseTransitionTable[i].length; j++) {
      const cell = document.createElement('td');
      const input = document.createElement('input');
      input.type = 'text';
      input.value = selectedPhaseTransition.phaseTransitionTable[i][j];
      cell.appendChild(input);
      row.appendChild(cell);
    }
    tbody.appendChild(row);
  }
}

// Обработчик события выбора фазового перехода в listbox
const phaseTransitionsListbox = document.getElementById('phase-transitions');
phaseTransitionsListbox.addEventListener('change', () => {
  const selectedIndex = phaseTransitionsListbox.selectedIndex;
  if (selectedIndex !== -1) {
    const selectedTransition = phaseTransitionsList[selectedIndex];
    fillPhaseTransitionFields(
      selectedTransition.sourcePhase,
      selectedTransition.targetPhase,
      selectedTransition.sourcePhaseNumber,
      selectedTransition.targetPhaseNumber,
      selectedTransition.temperature,
      selectedTransition.temperatureErr,
      selectedTransition.enthalpyTransition,
      selectedTransition.enthalpyTransitionErr,
      selectedTransition.entropyTransition,
      selectedTransition.entropyTransitionErr,
      selectedTransition.jumpHeatCapacity,
      selectedTransition.startTemperature,
      selectedTransition.endTemperature
    );
    populatePhaseTransitionTable(selectedTransition.phaseTransitionTable);
  }
});

function fillPhaseTransitionFields(
  sourcePhase,
  targetPhase,
  sourcePhaseNumber,
  targetPhaseNumber,
  temperature,
  temperatureErr,
  enthalpyTransition,
  enthalpyTransitionErr,
  entropyTransition,
  entropyTransitionErr,
  jumpHeatCapacity,
  startTemperature,
  endTemperature
) {
  // Заполнение полей формы данными выбранного перехода
  document.getElementById('source_phase').value = sourcePhase;
  document.getElementById('target_phase').value = targetPhase;
  document.getElementById('source_phase_number').value = sourcePhaseNumber;
  document.getElementById('target_phase_number').value = targetPhaseNumber;
  document.getElementById('temperature').value = temperature;
  document.getElementById('temperature_err').value = temperatureErr;
  document.getElementById('enthalpy_transition').value = enthalpyTransition;
  document.getElementById('enthalpy_transition_err').value = enthalpyTransitionErr;
  document.getElementById('entropy_transition').value = entropyTransition;
  document.getElementById('entropy_transition_err').value = entropyTransitionErr;
  document.getElementById('jump_heat_capacity').value = jumpHeatCapacity;
  document.getElementById('start_temperature').value = startTemperature;
  document.getElementById('end_temperature').value = endTemperature;
}

function populatePhaseTransitionTable(phaseTransitionTable) {
  const table = document.getElementById('phase-transition-table');
  const tbody = table.getElementsByTagName('tbody')[0];
  tbody.innerHTML = '';

  for (const row of phaseTransitionTable) {
    const tr = document.createElement('tr');
    for (const cell of row) {
      const td = document.createElement('td');
      const input = document.createElement('input');
      input.type = 'text';
      input.value = cell;
      td.appendChild(input);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
}


        </script>
        <div class="form-group">

        </div>
        <div class="form-group">
            <button class="add-button btn btn-primary" id="powerLawButton">Расчет степенной зависимости</button>
            <input type="text" id="powerLawExponent" placeholder="Показатель степени" class="form-control">
            <input type="text" id="powerLawCoefficient" placeholder="Коэффициент" class="form-control">
        </div>
        <script>

        </script>
        <button class="btn btn-primary" id="sendDataButton" onclick="sendData()">Отправить</button>
    </div>
</div>
<script>
  async function sendData() {
    // Инициализация переменных для тестов
    const substanceClass = $('[list="substance_class"]').val(); // Замените на тестовое значение
    const substanceType = $("#substance_type").val(); // Замените на тестовое значение
    const name = $("#name").val(); // Замените на тестовое значение
    const formula = $("#formula").val(); // Замените на тестовое значение
    const source = $("#source").val(); // Замените на тестовое значение
    const cas = $("#cas").val(); // Замените на тестовое значение
     // Пример тестовых данных для literatureList
    const AggregateStatesList = [{
        "state": 0,
        "agregate_state": "Glass",
        "number_phase": 6,
        "degree_of_crystallinity": 0.5,
        "enthalpy_of_combustion": 100.0,
        "enthalpy_of_combustion_err": 0.1,
        "enthalpy_of_formation": 50.0,
        "enthalpy_of_formation_err": 0.05,
        "entropy_of_formation": 10.0,
        "entropy_of_formation_err": 0.01,
        "gibbs_energy_of_formation": -20.0,
        "gibbs_energy_of_formation_err": 0.02,
        "lnK": 0.5,
        "residual_entropy_at_0_k": 1.0,
        "residual_entropy_at_0_k_err": 0.01,
        "configurational_entropy": 5.0,
        "configurational_entropy_err": 0.05,
        "difference_of_zero": 0.1,
        "difference_of_zero_err": 0.01,
        "T": [300, 310, 320],
        "Cp": [1.0, 1.1, 1.2],
        "HT_H0": [0.1, 0.2, 0.3],
        "ST": [0.01, 0.02, 0.03],
        "GT": [0.001, 0.002, 0.003]
    }];
    const phaseTransitionsList = [{
        "transition": 1,
        "source_phase": "Glass",
        "target_phase": "Glass",
        "source_phase_number": 1,
        "target_phase_number": 2,
        "temperature": 100,
        "temperature_err": 1,
        "enthalpy_transition": 50,
        "enthalpy_transition_err": 2,
        "entropy_transition": 30,
        "entropy_transition_err": 1,
        "jump_heat_capacity": 10,
        "start_temperature": 0,
        "end_temperature": 100
    }];
    const data = {
        substance_class: substanceClass,
        substance_type: substanceType,
        name: name,
        formula: formula,
        cas: cas,
        source: source,
        literature: literatureList,
        AggregateState: propertiesList,
        transactions_list: phaseTransitionsList,
    };
    console.log("Data to be sent:", JSON.stringify(data)); // Логирование данных
    try {
        const response = await fetch("/api/append/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify(data),
        });
        if (response.ok) {
            alert("Данные успешно отправлены");
        } else {
            const errorData = await response.json();
            console.error("Ошибка при отправке данных:", errorData);
            alert("Ошибка при отправке данных");
        }
    } catch (error) {
        console.error("Ошибка:", error);
        alert("Ошибка при отправке данных");
    }
}


</script>
{% else %}

    <div class="box onl-text-pg p-5 text-center bg-body-tertiary rounded-3">
    <h1 class="text-body-emphasis">Для добавления соединений войдите на сайт</h1>
        <button onclick="window.location.href='login'" class="btn btn-primary px-5 mb-5" type="button">
      Войти
    </button>
  </div>

{% endif %}
{% endblock %}
